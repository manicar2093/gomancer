// Code generated by gomancer
package controllers

import (
	"github.com/gookit/validate"
	"github.com/invopop/ctxi18n/i18n"
	"net/http"
	"test/cmd/service/controllers/posttestpages"
	"test/core/coretpls/toast"
	"test/core/validator"

	core "test/core"
	commonreq "test/core/commonreq"
	models "test/internal/domain/models"
	posttests "test/internal/posttests"

	echo "github.com/labstack/echo/v4"
)

const (
	ShowPostTestRouteName = "showPostTest"
)

type PostTestWebController struct {
	postTestRepository *posttests.PostTestRepository
}

func NewPostTestWebController(postTestRepository *posttests.UserRepository) *PostTestWebController {
	return &PostTestWebController{
		postTestRepository: postTestRepository,
	}
}

func (c *PostTestWebController) SetUpRoutes(group *echo.Group) {
	postTestsGroup := group.Group("/post_tests")

	// Show all postTest
	postTestsGroup.GET("", c.GetAllPaginatedHandler)
	// Send page to edit a user
	postTestsGroup.GET("/:id/edit", c.GetEditionHandler)
	// Sends page to registry a user
	postTestsGroup.GET("/new", c.GetRegistrationPageHandler)
	// Send page to show a user
	postTestsGroup.GET("/:id", c.GetShowUserPageHandler).Name = ShowPostTestRouteName
	// Creates a user
	postTestsGroup.POST("", c.SaveHandler)
	// Patch user
	postTestsGroup.PATCH("/:id", c.SaveHandler)
	// Updates all user
	postTestsGroup.PUT("/:id", c.PartialUpdateByIdHandler)
	// Deletes a user
	postTestsGroup.DELETE("/:id", c.DeleteByIdHandler)

}

func (c *PostTestWebController) SaveHandler(ctx echo.Context) error {
	var req = models.PostTest{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		if errorsMap, isValidationErr := validator.IsValidationError(err); isValidationErr {
			core.SetFlash(ctx, core.FlashMessage{
				Variant: string(toast.VariantError),
				Message: i18n.T(ctx.Request().Context(), "validation_error"),
			})
			return core.Render(ctx, http.StatusBadRequest, posttestpages.RegisterUserPage(&req, errorsMap))
		}
		return err
	}

	if err := c.postTestRepository.Save(&req); err != nil {
		return err
	}

	core.SetFlash(ctx, core.FlashMessage{
		Variant: string(toast.VariantSuccess),
		Message: i18n.T(ctx.Request().Context(), "correct_registry"),
		Title:   i18n.T(ctx.Request().Context(), "success"),
	})

	return ctx.Redirect(http.StatusSeeOther, ctx.Echo().Reverse(ShowPostTestRouteName, req.Id))
}

func (c *PostTestWebController) GetAllPaginatedHandler(ctx echo.Context) error {
	req := commonreq.PageData{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		return err
	}

	res, err := c.postTestRepository.GetAllPaginated(req.PageNumber, req.PageSize)
	if err != nil {
		return err
	}

	return core.Render(ctx, http.StatusOK, posttestpages.PostTestIndex(res))
}

func (c *PostTestWebController) PartialUpdateByIdHandler(ctx echo.Context) error {
	req := posttests.PartialUpdateByIdInput{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		return err
	}
	res, err := c.postTestRepository.PartialUpdateById(req)
	if err != nil {
		return err
	}

	core.SetFlash(ctx, core.FlashMessage{
		Variant: string(toast.VariantSuccess),
		Message: i18n.T(ctx.Request().Context(), "correct_update"),
		Title:   i18n.T(ctx.Request().Context(), "success"),
	})

	return ctx.Redirect(http.StatusSeeOther, ctx.Echo().Reverse(ShowUserRouteName, res.Id))
}

func (c *PostTestWebController) DeleteByIdHandler(ctx echo.Context) error {
	req := struct {
		commonreq.GetByIdUUID
		commonreq.PageData
	}{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		return err
	}
	if err := c.postTestRepository.DeleteById(req.Id); err != nil {
		return err
	}

	core.SetFlash(ctx, core.FlashMessage{
		Variant: string(toast.VariantSuccess),
		Message: i18n.T(ctx.Request().Context(), "correct_deletion"),
		Title:   i18n.T(ctx.Request().Context(), "success"),
	})

	return ctx.Redirect(http.StatusSeeOther, "/app/post_tests?page_number=1")
}

func (c *PostTestWebController) GetRegistrationPageHandler(ctx echo.Context) error {
	return core.Render(ctx, http.StatusOK, posttestpages.RegisterUserPage(&models.User{}, nil))
}

func (c *PostTestWebController) GetShowUserPageHandler(ctx echo.Context) error {
	req := commonreq.GetByIdUUID{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		return err
	}

	res, err := c.postTestRepository.GetById(req.Id)
	if err != nil {
		return err
	}

	return core.Render(ctx, http.StatusOK, posttestpages.ShowUser(res))
}

func (c *PostTestWebController) GetEditionHandler(ctx echo.Context) error {
	req := commonreq.GetByIdUUID{}
	if err := core.BindAndValidate(ctx, &req); err != nil {
		return err
	}
	res, err := c.postTestRepository.GetById(req.Id)
	if err != nil {
		return err
	}
	return core.Render(ctx, http.StatusOK, posttestpages.EditUserPage(res, validate.Errors{}))
}
